VI - Log Management and Performance

A - Introduction
Linux is an open-source operating system derived from the Unix kernel. It is now one of the most widely used operating systems on a variety of devices. You may be familiar with the different distributions of Linux, including Ubuntu, CentOS, and Red Hat Enterprise Linux (RHEL). These systems share the same Linux kernel, which allows them to have a logging framework designed to monitor the system and its services.

The Linux logging structure includes a set of directories, files, services, and commands that administrators can leverage. As a Linux system administrator, it is essential to know the locations, commands, and configuration of logs in order to effectively troubleshoot issues affecting the systems or applications you manage.

We will review the basics of logging under Linux: the logging structure, the locations of log files, and the different types of daemons and logging protocols (such as syslog and rsyslog). Finally, we will look at some commonly used commands to read and search through a system's logs.

In this section, we will cover the following basics of logging in Linux:

The location of Linux log files, their format, and how to read them.
How to read the most important logs (such as syslog).
How to configure the syslog daemon on Ubuntu. The principle of Linux log rotation and the use of thelogrotate* utility.
B - Searching for Linux System Logs
All system logs of Ubuntu are stored in the directory /var/log. Let's access this directory in the terminal using the command below:

cd /var/log
You can display the contents of this directory by executing the following command:

ls /var/log
Output display:

alternatives.log  apt       cloud-init-output.log  dmesg       dpkg.log  landscape    mysql           private   syslog.2.gz  ubuntu-advantage-timer.log  wtmp
amazon            auth.log  cloud-init.log         dmesg.0     journal   lastlog      nginx           syslog    syslog.3.gz  ubuntu-advantage.log
apache2           btmp      dist-upgrade           dmesg.1.gz  kern.log  letsencrypt  php7.4-fpm.log  syslog.1  syslog.4.gz  unattended-upgrades
Let's examine some of the essential system log files that may be present in the /var/log directory and see what they contain:

/var/log/syslog : records general information about the overall activity of the system.
/var/log/auth.log : logs all security-related actions (logins, logouts, and activities of the root user).
/var/log/kern.log : contains information about events generated by the Linux kernel.
/var/log/boot.log : contains system boot messages.
/var/log/dmesg : contains messages related to device drivers.
/var/log/faillog : logs failed login attempts, useful during investigations of intrusion attempts.
The directory /var/log is also used to store application logs. If your system uses NGINX or MySQL, installed by default or added later, their log files will also be found here.

C - Displaying the contents of a Linux log file
c.1 - Presentation
Log files contain a wealth of useful information for monitoring or analyzing the activities of the system or a specific application. Therefore, a Linux server administrator must understand the various messages present in these files in order to effectively diagnose and resolve an issue.

Before being able to read log files, it is necessary to understand their format. We will examine two fundamental approaches to log storage: plain text and binary files.

c.2 - Plain Text Log Files
These logs are plain text files with a standardized format. Under Ubuntu, the log model used is RSYSLOG_TraditionalFileFormat. This format consists of four main fields separated by a space:

The timestamp indicates the time at which a log entry was created, in the format MMM dd HH:mm:ss (for example Sep 28 19:00:00). Note: this format does not include the year.
The hostname corresponds to the system that originally generated the message.
The application is the one that produced the message.
The message contains the details of the event.
Let's now examine some log files in plain text format. Run the command below to display the contents of the file /var/log/syslog using the tail utility. The tail command shows the last 10 lines of the file:

sudo tail /var/log/syslog
Output display:

Nov 18 09:39:59 ip-172-31-24-148 systemd[1426]: Listening on D-Bus User Message Bus Socket.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1426]: Reached target Sockets.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1426]: Reached target Basic System.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1426]: Reached target Main User Target.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1426]: Startup finished in 59ms.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1]: Started User Manager for UID 1000.
Nov 18 09:39:59 ip-172-31-24-148 systemd[1]: Started Session 1 of user ubuntu.
Nov 18 09:40:10 ip-172-31-24-148 systemd[1]: systemd-hostnamed.service: Succeeded.
Nov 18 09:40:10 ip-172-31-24-148 systemd[1]: systemd-timedated.service: Succeeded.
Nov 18 09:40:40 ip-172-31-24-148 systemd-timesyncd[382]: Initial synchronization to time server 169.254.169.123:123 (169.254.169.123).
You will notice that each record in this file is formatted in the manner described previously.

For example, the last record has:

For timestamp Nov 18 09:40:40.

Like hostname (host name) ip-172-31-24-148

Like application systemd-timesyncd[382]

As message: Initial synchronization to time server 169.254.169.123:123 (169.254.169.123).

If you want to display the entire log file, you can use the cat utility or any text editor such as nano or vim.

c.3 - Binary Log Files
Although plain text is the dominant storage format for log files, there are also binary log files that cannot be read with a standard text editor. The directory /var/log contains several binary files related to user connection management:

/var/log/utmp : records the users currently logged into the system.
/var/log/wtmp : records users who have logged in previously. It contains historical information from utmp.
/var/log/btmp : records failed login attempts.
For these binary logs, specific command-line tools allow displaying the information in a human-readable form.

To view the contents of the file /var/log/utmp, use the who utility with the -H option (which displays the column headers in the output):

who -H
Output display:

NAME     LINE         TIME             COMMENT
ubuntu   pts/0        2022-11-18 09:40 (3.8.37.29)
The output above describes all currently connected users, the login time, and the IP address of their host machine.

You can also view the contents of the binary file /var/log/wtmp using the last command as shown below:

last -R
Output display:

ubuntu   pts/0        Fri Nov 18 09:40   still logged in
reboot   system boot  Fri Nov 18 09:38   still running
ubuntu pts/0 Thu Nov 17 13:40 - 17:38 (03:58)
ubuntu pts/0 Thu Nov 17 12:42 - 13:39 (00:57)
ubuntu pts/0 Thu Nov 17 11:59 - 12:40 (00:41)
ubuntu pts/0 Wed Nov 16 15:15 - 11:57 (20:42)
ubuntu pts/0 Wed Nov 16 11:23 - 15:01 (03:37)
ubuntu pts/0 Wed Nov 16 09:56 - 11:20 (01:23)
ubuntu pts/0 Tue Nov 15 10:39 - 15:38 (04:59)
ubuntu pts/0 Tue Nov 15 09:29 - 10:10 (00:41)
ubuntu pts/0 Mon Nov 14 16:41 - 09:11 (16:30)
ubuntu pts/0 Mon Nov 14 15:00 - 16:08 (01:08)
ubuntu pts/0 Mon Nov 14 06:14 - 10:17 (04:03)
reboot system boot Mon Nov 14 06:12 - 17:38 (3+11:26)
ubuntu pts/0 Sun Nov 13 10:06 - 12:06 (02:00)
ubuntu pts/0 Sun Nov 13 07:12 - 10:06 (02:54)
ubuntu pts/0 Sun Nov 13 05:33 - 06:57 (01:24)
reboot system boot Sun Nov 13 05:32 - 23:21 (17:49)
The output displays a table in which the first column refers to the username (the restart of the pseudo-user is recorded each time the system is rebooted). The third field refers to the login timestamp and the last column indicates the session duration.

To examine the file /var/log/btmp (which contains failed login attempts), run the command lastb with sudo privileges:

sudo lastb
Output display:

         ssh:notty    64.62.197.235    Fri Nov 18 09:52 - 09:52  (00:00)
         ssh:notty    64.62.197.237    Thu Nov 17 12:28 - 12:28  (00:00)
pi       ssh:notty    80.189.211.141   Thu Nov 17 02:31 - 02:31  (00:00)
pi       ssh:notty    80.189.211.141   Thu Nov 17 02:31 - 02:31  (00:00)
guest    ssh:notty    15.228.248.179   Thu Nov 17 01:52 - 01:52  (00:00)
guest    ssh:notty    15.228.248.179   Thu Nov 17 01:50 - 01:50  (00:00)
guest    ssh:notty    15.228.248.179   Thu Nov 17 01:50 - 01:50  (00:00)
git      ssh:notty    15.228.248.179   Thu Nov 17 01:48 - 01:48  (00:00)
guest    ssh:notty    15.228.248.179   Thu Nov 17 01:48 - 01:48  (00:00)
git      ssh:notty    15.228.248.179   Thu Nov 17 01:47 - 01:47  (00:00)
git      ssh:notty    15.228.248.179   Thu Nov 17 01:47 - 01:47  (00:00)
git      ssh:notty    15.228.248.179   Thu Nov 17 01:46 - 01:46  (00:00)
test     ssh:notty    15.228.248.179   Thu Nov 17 01:46 - 01:46  (00:00)
test     ssh:notty    15.228.248.179   Thu Nov 17 01:45 - 01:45  (00:00)
test     ssh:notty    15.228.248.179   Thu Nov 17 01:45 - 01:45  (00:00)
test     ssh:notty    15.228.248.179   Thu Nov 17 01:44 - 01:44  (00:00)
The output shows users who failed to log in along with the corresponding timestamp.

c.4 - Configuration of the syslog daemon
All system logs are created and managed by a background process called daemon. The traditional Linux daemon for logging is syslogd. However, Ubuntu 24.04 uses the rsyslogd daemon, which is an extension of syslogd. It uses a specific configuration file (/etc/rsyslog.conf) that defines the logging rules.

To display the contents of the file /etc/rsyslog.conf, use the command cat. This command shows the entire configuration file, but we will only show a partial output here:

cat /etc/rsyslog.conf
Output display:

# /etc/rsyslog.conf configuration file for rsyslog
#
# For more information install rsyslog-doc and see
# /usr/share/doc/rsyslog-doc/html/configuration/index.html
#
# Default logging rules can be found in /etc/rsyslog.d/50-default.conf


#################
#### MODULES ####
#################

module(load="imuxsock") # provides support for local system logging
#module(load="immark")  # provides --MARK-- message capability

# provides UDP syslog reception
#module(load="imudp")
#input(type="imudp" port="514")

# provides TCP syslog reception
#module(load="imtcp")
#input(type="imtcp" port="514")

# provides kernel logging support and enable non-kernel klog messages
module(load="imklog" permitnonkernelfacility="on")

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

# Filter duplicated messages
$RepeatedMsgReduction on

#
# Set the default permissions for all log files.
#
$FileOwner syslog
$FileGroup adm
$FileCreateMode 0640
$DirCreateMode 0755
$Umask 0022
$PrivDropToUser syslog
$PrivDropToGroup syslog

#
# Where to place spool and state files
#
$WorkDirectory /var/spool/rsyslog

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf
This file contains a lot of information, but we will focus on two configuration parameters.

First of all, a variable called $ActionFileDefaultTemplate defines the syslog log format. You can change the value of this variable if the default log format does not suit you.

Secondly, the last line of the file defines a variable called $IncludeConfig, which specifies the directory of additional configuration files.

On Ubuntu, all additional Rsyslog rules are placed in the file /etc/rsyslog.d/50-default.conf, which is the default file.

To view the contents of this file, use the head utility (the -n 15 option allows you to display only the first 15 lines):

head -n 15 /etc/rsyslog.d/50-default.conf
Output display:

#  Default rules for rsyslog.
#
# For more information see rsyslog.conf(5) and /etc/rsyslog.conf

#
# First some standard log files.  Log by facility.
#
auth,authpriv.*                 /var/log/auth.log
<i>.</i>;auth,authpriv.none          -/var/log/syslog
#cron.*                         /var/log/cron.log
#daemon.*                       -/var/log/daemon.log
kern.*                          -/var/log/kern.log
#lpr.*                          -/var/log/lpr.log
mail.*                          -/var/log/mail.log
#user.*                         -/var/log/user.log
The output contains rsyslogd configuration rules. Each non-empty line (or line that does not start with the character #) defines a rule.

The definition of each rule starts with a selector, followed by one or more spaces and an action field:

The selector indicates the category of messages and their priority. The selector </i> refers to all categories and priorities. * The action field of a selector generally refers to a log file.

D - Log File Rotation in Linux
The size of log files must be monitored, as they constantly increase over time. Each system has limited resources, and overly large logs can cause performance issues, excessive memory usage, and loss of storage space.

Linux distributions generally solve this problem through the concept of log rotation, which continuously repeats the following actions:

Instead of continuously writing to the same log file, the existing file receives a version suffix, and a new file is created for new entries. This means that a log file contains multiple backups that are eventually compressed.
When the backup files reach a specified number, the system deletes the oldest ones.
Let's see an example of log file rotation under Linux. Run the command ls with the following options:

ls -l -h -t /var/log/syslog*
The -l option displays a list including various metadata of the file, the -h option makes the file size human-readable, and the -t option sorts the list by modification date (most recent first). The argument /var/log/syslog* specifies that only files in the /var/log directory with the prefix syslog should be included in the output.

Output display:

-rw-r----- 1 syslog adm  16K Nov 18 10:09 /var/log/syslog
-rw-r----- 1 syslog adm 208K Nov 18 09:39 /var/log/syslog.1
-rw-r----- 1 syslog adm  12K Nov 17 00:00 /var/log/syslog.2.gz
-rw-r----- 1 syslog adm 7.8K Nov 16 00:00 /var/log/syslog.3.gz
-rw-r----- 1 syslog adm  50K Nov 15 00:00 /var/log/syslog.4.gz
This output describes all versions of the file syslog. Generally, this is the largest log file, as it records almost all events occurring on the system. Older versions are labeled with a version suffix (syslog.4.gz is the oldest Syslog backup).

Note that the backup files are all compressed using the GNU gzip algorithm (as evidenced by the .gz extension). This helps save space, as log files can reach sizes on the order of gigabytes. You will also notice that these files cover a time span of only three days.

E - Configuration of the logrotate daemon
The rotation of logs is managed by a system daemon called logrotate. Like rsyslogd, this daemon uses a specific configuration file, logrotate.conf, located in the /etc directory.

Let's display the content of the logrotate configuration file using the cat utility:

cat /etc/logrotate.conf
Output display:

# see "man logrotate" for details
# rotate log files weekly
weekly

# use the adm group by default, since this is the owning group
# of /var/log/syslog.
su root adm

# keep 4 weeks worth of backlogs
rotate 4

# create new (empty) log files after rotating old ones
create

# use date as a suffix of the rotated file
#dateext

# uncomment this if you want your log files compressed
#compress

# packages drop log rotation information into this directory
include /etc/logrotate.d

# system-specific logs may be also be configured here.
The output describes the global configuration for logrotate. Log files are configured for weekly rotation: the system keeps four backups and compression is disabled. However, this is the most general configuration for any log. It is also possible to set up a specific configuration for a particular log file.

On Ubuntu, the configuration for specific logs is by default located in the directory /etc/logrotate.d (you will notice the presence of this directory in /etc/logrotate.conf).

To display the contents of the directory /etc/logrotate.d, execute the command ls :

ls /etc/logrotate.d/
Output display:

alternatives apache2 apport apt bootlog btmp certbot dpkg mysql-server nginx php7.4-fpm rsyslog ubuntu-advantage-tools ufw unattended-upgrades wtmp

You will notice that the rsyslog daemon has its own log rotation configuration file. To view the first 15 lines of the rsyslog file, use the head utility:

head -n 15 /etc/logrotate.d/rsyslog
Output display:

/var/log/syslog
{
        rotate 7
        daily
        missingok
        notifempty
        delaycompress
        compress
        postrotate
                /usr/lib/rsyslog/rsyslog-rotate
        endscript
}

/var/log/mail.info
/var/log/mail.warn
This output indicates that the syslog file is subject to daily rotation and that seven compressed backups are kept, before the oldest ones are deleted.

You can immediately force the rotation of a log file using logrotate by executing the following command:

sudo logrotate -fv /etc/logrotate.conf
The -f option forces an immediate rotation, while the -v option enables verbose mode (which results in messages being displayed during the rotation).

The beginning of the output indicates that the logrotate daemon starts by reading all its configuration files before proceeding. The complete output is very long, as it displays every detail of the rotation process.

F - Performance Management
Servers are often used for general tasks, including compute and memory-intensive operations. To ensure accurate monitoring, we use various tools, commands, and utilities to optimize their performance.

f.1 - The TOP command
The command top allows you to display in real-time all the currently running Linux processes. It provides a dynamic and real-time view of system activity. More specifically, the command displays a summary of the system as well as a list of processes or threads, sorted by their CPU usage and managed by the Linux kernel.

Highly valued by system administrators, this utility offers a limited interactive interface for process management, as well as a more comprehensive interface for personal configuration, covering all aspects of its operation. By default, the list of processes is updated every 3 seconds :

 top
 top - 10:31:14 up 53 min,  1 user,  load average: 0.00, 0.00, 0.00
 Tasks: 112 total,   1 running, 111 sleeping,   0 stopped,   0 zombie
 %Cpu(s):  0.2 us,  0.0 sy,  0.0 ni, 99.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.2 st
 MiB Mem :   3921.0 total,   3207.8 free,    278.0 used,    435.2 buff/cache
 MiB Swap:      0.0 total,      0.0 free,      0.0 used.   3422.2 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
   1919 ubuntu    20   0   11016   3912   3240 R   0.3   0.1   0:00.01 top
      1 root      20   0  102604  11220   8148 S   0.0   0.3   0:05.52 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kthreadd
      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp
      5 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 netns
      7 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker/0:0H-events_highpri
      9 root       0 -20       0      0      0 I   0.0   0.0   0:00.06 kworker/0:1H-events_highpri
     10 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 mm_percpu_wq
     11 root      20   0       0      0      0 S   0.0   0.0   0:00.00 rcu_tasks_rude_
     12 root      20   0       0      0      0 S   0.0   0.0   0:00.00 rcu_tasks_trace
     13 root      20   0       0      0      0 S   0.0   0.0   0:00.04 ksoftirqd/0
     14 root      20   0       0      0      0 I   0.0   0.0   0:00.09 rcu_sched
     15 root      rt   0       0      0      0 S   0.0   0.0   0:00.01 migration/0
     16 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 idle_inject/0
     18 root      20   0       0      0      0 S   0.0   0.0   0:00.00 cpuhp/0
     19 root      20   0       0      0      0 S   0.0   0.0   0:00.00 cpuhp/1
     20 root     -51   0       0      0      0 S   0.0   0.0   0:00.00 idle_inject/1
     21 root      rt   0       0      0      0 S   0.0   0.0   0:00.41 migration/1
     22 root      20   0       0      0      0 S   0.0   0.0   0:00.03 ksoftirqd/1
     24 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker/1:0H-events_highpri
     25 root       0 -20       0      0      0 I   0.0   0.0   0:00.06 kworker/1:1H-events_highpri
     26 root      20   0       0      0      0 S   0.0   0.0   0:00.00 kdevtmpfs
     27 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 inet_frag_wq
     28 root      20   0       0      0      0 S   0.0   0.0   0:00.01 kauditd
     29 root      20   0       0      0      0 S   0.0   0.0   0:00.00 khungtaskd
The first line indicates the current time, the duration since the system has been operational, the number of active user sessions, and the average load of the system over the intervals of 1, 5, and 15 minutes.

The second line displays information about:

the total number of processes;
the number of running processes;
the number of sleeping processes (in standby);
the number of stopped processes;
the number of zombie processes.
The two lines below the output display information related to RAM and SWAP memory usage.

Next come the process-related information:

The ID of the process.
The user owning the process.
The priority of the process.
The nice value.
The virtual memory.
The physical memory.
The shared memory used by the process.
The state of the process.
The CPU and RAM usage.
The uptime.
The refresh rate can be customized. By default, it is set to 3 seconds, but you can change it by pressing the d key and entering the desired delay value.

To terminate a process, press k while running top. A prompt will then ask you to enter the PID, and then press Enter.

Output display:

PID to signal/kill [default pid = 1]
This action will send the SIGTERM signal, which terminates the process in a controlled manner. You can also send SIGKILL or any other signal.

It is also possible to directly enter a signal number. For example, SIGKILL corresponds to the number 9 and SIGTERM to the number 15.

The list of processes can be sorted according to different criteria. When top is running in interactive mode, you can use the following keys:

P : sort by CPU usage ;
M : sort by memory usage ;
T : sort by "Time" column ;
N : sort by process number (PID).
f.2 - The htop command
htop is a modernized and improved version of the top command. It supports mouse interaction, incorporates all the features of top, and offers additional advanced options.


It is even more interactive and offers more search, filtering, and sorting options than top. Since the output is colored and can scroll vertically and horizontally using the mouse, operations are easier to perform.

Moreover, it is no longer necessary to manually enter the process number or the priority value to modify a process. By pressing e, you can display the environment of the process. At the bottom of the interactive interface of htop, you will also find the menu of possible actions on a process.

Thus, system administrators often prefer htop for its enhanced display options and ease of use.